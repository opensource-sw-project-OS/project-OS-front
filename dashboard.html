<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ëŒ€ì‹œë³´ë“œ</title>
  <style>
    header{
            position: fixed;

            /* í•˜ìœ„ìš”ì†ŒëŠ” íˆ¬ëª…ë„ ì ìš©ë˜ì§€ ì•Šë„ë¡ opacityì•„ë‹Œ rgba */
            background-color: rgb(255, 255, 255, 0.4);

            /* í™”ë©´ ë„ˆë¹„ì— ê½‰ì°¨ë„ë¡ */
            width: 100%;    

            /* ê°­ ì—†ì• ì£¼ê¸° */
            top: 0;
            left: 0;
            right: 0;
            height: 70px;

            /* ê·¸ë¦¼ì ìƒì„± */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);

            align-items: center;
            padding:0 150px;
            /* ì§€ì •í•œ ì‚¬ì´ì¦ˆ ë‚´ì— paddingë„ í¬í•¨ */
            box-sizing: border-box;
            
            display: flex;

            /* ë‘ ìš”ì†Œê°€ ì–‘ëìœ¼ë¡œ ê°€ë„ë¡ */
            justify-content: space-between; 
        }

    .title{
            white-space: nowrap;
            font-size:22px;
            font-weight: bold;
        }

    
    .navigation-menu {
      flex-shrink: 0; 
      display: flex;
      gap: 30px;
      list-style-type: none;
    }

    .navigation-menu a {
      text-decoration: none;
      font-weight: bold;
      color: black;
      cursor: pointer;
    }

    @font-face {
      font-family: 'SUIT';
      font-style: normal;
      font-weight: 400;
      src: url('https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT-Regular.woff2') format('woff2');
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'SUIT', sans-serif;
      display: flex;
      height: 100vh;
      background: linear-gradient(to bottom, #d7dadd 0%, #c4c9d6 60%, #b0c4db 100%);
    }
    .side-menu {
      width: 220px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 100px 0;
      gap: 20px;
    }
    .pill-menu {
      margin-top: 13px;
      margin-left: 100px;
      display: flex;
      align-items: center;
      gap: 30px;
      background: rgba(255, 255, 255, 0.3);
      width: 250px;
      padding: 12px 25px;
      border-radius: 9999px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      color: #333;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      backdrop-filter: blur(10px);
    }
    .pill-menu:hover {
      background: rgba(255, 255, 255, 0.6);
    }
    .pill-menu img {
      margin-left: 20px;
      width: 33px;
      height: 33px;
    }
    .main-content {
      flex: 1;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-y: auto;
      gap: 20px;
      margin-top: 70px;
    }
    .glass-box {
      max-width: 600px;
      width: 100%;
      padding: 20px;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 20px;
      backdrop-filter: blur(15px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      text-align: center;
    }
    .glass-row-2 {
      display: flex;
      gap: 20px;
      width: 90%;
      text-align: center;
    }
    .glass-col {
      flex: 1;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 20px;
      padding: 40px;
      backdrop-filter: blur(15px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      margin-top: 20px;
    }

    .glass-wrapper {
      width: 100%;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }

    canvas {
      text-align: center;
      margin-top: 20px;
      background: transparent;
      border-radius: 10px;
    }
    #map {
      width: 100%;
      height: 400px;
      border-radius: 10px;
      margin-top: 20px;
    }
    #preview, #croppedResult {
      max-width: 100%;
      max-height: 250px;
      margin-top: 10px;
      border: 1px solid #ccc;
      display: none;
    }
      #calendar-container {
    background-color: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 50px;
    max-width: 900px;
    margin: 10px auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  .fc-daygrid-day-number {
    font-size: 14px;
  }
  .fc-event-title {
    font-size: 28px !important; /* ì´ëª¨í‹°ì½˜ í¬ê²Œ */
    line-height: 1.2;
  }
  .fc-event-time {
    display: none;
  }
  .fc-event-description {
    font-size: 10px;
    color: #444;
  }
  .emotion-diary-container {
    display: flex;
    flex-direction: row;
    gap: 40px; /* ê° ì»¬ëŸ¼ ì‚¬ì´ ê°„ê²© */
    justify-content: space-between;
    padding: 20px;
  }

  .emotion-diary-container .glass-col {
    flex: 1;
    min-width: 0;
    text-align: center;
  }
  .emotion-table {
    flex: 1.2;
  }
  .emotion-table table {
    width: 100%;
    border-collapse: collapse;
    text-align: center;
    border: none; /* ì „ì²´ í…Œë‘ë¦¬ ì œê±° */
  }
  .emotion-table th, .emotion-table td {
    padding: 10px;
    border-bottom: 1px solid #b2b0b0;
  }
  .emotion-table thead tr {
    border-top: none;
    border-left: none;
    border-right: none;
  }
  #dailyFeelingInput {
  width: 100%;
  height: 100px;
  padding: 12px 20px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
  }
  #affirmationBox {
    text-align: center;
  }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="apikey.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.140.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.140.2/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.140.2/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <!-- í™”ë©´ í•´ìƒë„ì— ë”°ë¼ ê¸€ì í¬ê¸° ëŒ€ì‘(ëª¨ë°”ì¼ ëŒ€ì‘) -->
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <!-- jquery CDN -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- fullcalendar CDN -->
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.js'></script>
  <!-- fullcalendar ì–¸ì–´ CDN -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/locales-all.min.js'></script>

</head>
  <body>
    <header>
        <div class="title">Project OS</div>
            <ul class="navigation-menu">
      <li><a href="project_os_intro.html">Home</a></li>
      <li><a href="#" onclick="logout()">Logout</a></li>
    </ul>
    </header>
    <aside class="side-menu">
      <div class="pill-menu" onclick="showReceiptInput()">
        <img src="https://img.icons8.com/?size=100&id=123771&format=png&color=737373" alt="ì…ë ¥"> ì…ë ¥
      </div>
      <div class="pill-menu" onclick="showSpending()">
        <img src="https://img.icons8.com/?size=100&id=8322&format=png&color=737373" alt="ê·¸ë˜í”„"> ê·¸ë˜í”„
      </div>
      <div class="pill-menu" onclick="showBudget()">
        <img src="https://img.icons8.com/?size=100&id=7985&format=png&color=737373" alt="ì˜ˆì‚°"> ì˜ˆì‚°
      </div>
      <div class="pill-menu" onclick="showCalendar()">
        <img src="https://img.icons8.com/?size=100&id=10053&format=png&color=737373" alt="ë‹¬ë ¥"> ë‹¬ë ¥
      </div>
      <div class="pill-menu" onclick="showEmotionDiary()">
        <img src="https://img.icons8.com/?size=100&id=6UIyI0qTHfth&format=png&color=737373" alt="ë‹¤ì´ì–´ë¦¬"> ë‹¤ì´ì–´ë¦¬
      </div>
    </aside>
  
    <main class="main-content" id="main"></main>
  
    <script>
        // ë¡œê·¸ì¸ëœ ìœ ì € í† í° ë° ID ì €ì¥
  let user_token = localStorage.getItem('token');
  let user_id = localStorage.getItem('Userid');


  if (!user_token) {
  alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
  window.location.href = "login.html";
}


  function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('Userid');
    window.location.href = 'project_os_intro.html';
  }

  async function uploadOCRImage(blob) {
    const formData = new FormData();
    formData.append('image', blob);

    try {
      const res = await fetch("http://localhost:3000/api/ocr", {
        method: "POST",
        body: formData,
        headers: {
          Authorization: `Bearer ${user_token}`
        }
      });
      const data = await res.json();
      return data; // { date: ..., amount: ... }
    } catch (err) {
      console.error("OCR ì—…ë¡œë“œ ì˜¤ë¥˜:", err);
      return null;
    }
  }

  function getTodayDate() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function showReceiptInput() {
    const main = document.getElementById("main");
    if (!main) return;

    main.innerHTML = `
      <div class="glass-row-2">
        <div class="glass-col">
          <h3>ì˜¤ëŠ˜ì˜ ì§€ì¶œì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</h3>
          <input type="file" id="upload" accept="image/*" style="margin-top:10px; padding:8px 16px; border:none; background:#83A2DB; color:white; border-radius:8px;" />
          <img id="preview" style="max-width:100%; display:none;" />
          <img id="croppedResult" style="max-width:100%; display:none;" />
          <div id="ocrResult"></div>
          <br>
          <label>ë¶„ì•¼ ì„ íƒ:</label>
          <select id="category">
            <option value="ì‹ë¹„">ì‹ë¹„</option>
            <option value="êµí†µ">êµí†µ</option>
            <option value="í¸ì˜ì ">í¸ì˜ì </option>
            <option value="êµ¬ë…">êµ¬ë…</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
          <br><br>
          <button id="confirmCrop" style="margin-top:10px; padding:8px 16px; border:none; background:#83A2DB; color:white; border-radius:8px;"> í¬ë¡­ </button>
          <button id="runOCR" style="margin-top:10px; padding:8px 16px; border:none; background:#83A2DB; color:white; border-radius:8px;"> OCR ì‹¤í–‰ </button>

          <div style="margin-top:20px;">
            <input type="text" id="manualDate" placeholder="ë‚ ì§œ (ì˜ˆ: 2025-06-01)" value="${getTodayDate()}" />
            <input type="number" id="manualAmount" placeholder="ì´í•© ê¸ˆì•¡ (â‚©)" />
          </div>
        </div>

        <div class="glass-col">
          <h3>ì˜¤ëŠ˜ì˜ ê°ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</h3>
          <input type="text" id="dailyFeelingInput" />
          <button id="submitBtn" style="margin-top:10px; padding:8px 16px; border:none; background:#83A2DB; color:white; border-radius:8px;">ì˜¤ëŠ˜ì˜ ê¸°ë¡ ì €ì¥</button>
          <div id="submitResult"></div>
        </div>
      </div>
    `;

    let cropper = null;
    let croppedBlob = null;

    document.getElementById("upload").addEventListener("change", () => {
      const file = upload.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result;
        preview.style.display = 'block';
        if (cropper) cropper.destroy();
        cropper = new Cropper(preview, { aspectRatio: NaN, viewMode: 1 });
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("confirmCrop").addEventListener("click", () => {
      if (!cropper) return;
      const canvas = cropper.getCroppedCanvas();
      canvas.toBlob(blob => {
        croppedBlob = blob;
        croppedResult.src = URL.createObjectURL(blob);
        croppedResult.style.display = 'block';
        preview.style.display = 'none';
        cropper.destroy();
      });
    });

    document.getElementById("runOCR").addEventListener("click", async () => {
      if (!croppedBlob) return alert("í¬ë¡­ í›„ OCR ì‹¤í–‰í•´ì£¼ì„¸ìš”");
      const result = await uploadOCRImage(croppedBlob);
      if (result) {
        document.getElementById("manualDate").value = result.date || getTodayDate();
        document.getElementById("manualAmount").value = result.amount || "";
        document.getElementById("ocrResult").innerText = "OCR ì¸ì‹ ì„±ê³µ";
      } else {
        document.getElementById("ocrResult").innerText = "OCR ì‹¤íŒ¨";
      }
    });

    document.getElementById("submitBtn").addEventListener("click", async () => {
      const date = document.getElementById("manualDate").value;
      const total = document.getElementById("manualAmount").value;
      const emotion = document.getElementById("dailyFeelingInput").value;
      const category = document.getElementById("category").value;
      const resultBox = document.getElementById("submitResult");

      if (!date || !total || !emotion || !category) {
        resultBox.innerText = "ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        return;
      }

      try {
        const res = await fetch("http://localhost:3000/api/data", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${user_token}`
          },
          body: JSON.stringify({
            date,
            total,
            emotion_string: emotion,
            category
          })
        });

        const data = await res.json();
        if (!data.err) {
          resultBox.innerText = `ì €ì¥ ì™„ë£Œ: ${data.emotion_response || "ì²˜ë¦¬ë¨"}`;
        } else {
          resultBox.innerText = `ì—ëŸ¬ ë°œìƒ: ${data.err}`;
        }
      } catch (err) {
        resultBox.innerText = `ì „ì†¡ ì‹¤íŒ¨: ${err.message}`;
      }
    });
  }

  function toggleResult() {
    const container = document.getElementById("resultContainer");
    container.style.display = (container.style.display === "none") ? "block" : "none";
  }

  async function loadAffirmation() {
    try {
      const res = await fetch("https://cors-anywhere.herokuapp.com/https://www.affirmations.dev/");
      if (!res.ok) throw new Error("ë¦¬ì†ŒìŠ¤ ìš”ì²­ ì‹¤íŒ¨");

      const data = await res.json();
      const quote = data.affirmation;

      document.getElementById("affirmationBox").innerHTML = `
        <h3>ì˜¤ëŠ˜ì˜ ê¸ì • ë¬¸êµ¬ ğŸŒ¼</h3>
        <p style="font-size:18px;">"${quote}"</p>
      `;
    } catch (err) {
      document.getElementById("affirmationBox").innerHTML = `<p>ê¸ì • ë¬¸êµ¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
      console.error("ì˜¤ë¥˜ ë°œìƒ:", err);
    }
  }

async function showBudget() {
  const main = document.getElementById("main");

  // ì´ë²ˆ ë‹¬ ì‚¬ìš© ê¸ˆì•¡ ì„œë²„ì—ì„œ ë°›ì•„ì˜¤ê¸°
  let usedAmount = 0;
  try {
    const res = await fetch(`http://localhost:3000/api/receipts/usage/month/${user_id}`, {
      headers: { Authorization: `Bearer ${user_token}` }
    });
    const data = await res.json();
    usedAmount = data.total_used || 0;
  } catch (err) {
    console.error("ì´ë²ˆ ë‹¬ ì‚¬ìš© ê¸ˆì•¡ ì¡°íšŒ ì‹¤íŒ¨:", err);
  }

  main.innerHTML = `
    <div class="glass-box">
      <h2>ì´ë²ˆ ë‹¬ ì˜ˆì‚°</h2>
      <p style="font-size: 16px; margin-bottom: 15px;">ì´ë²ˆ ë‹¬ ì§€ì¶œ ì´í•©: <strong>${usedAmount.toLocaleString()}ì›</strong></p>
      <input type="number" id="totalBudget" placeholder="ì´ ì˜ˆì‚° ì…ë ¥ (â‚©)" style="padding: 5px 16px; margin-bottom: 10px; border-radius: 8px;" />
      <input type="number" id="usedBudget" value="${usedAmount}" readonly style="padding: 5px 16px; margin-bottom: 20px; border-radius: 8px; background:#eee; display: none;" />
      <button onclick="drawChart()" style="margin-top:10px; padding:8px 16px; border:none; background:#83A2DB; color:white; border-radius:8px;">í•œëˆˆì— í™•ì¸</button>
      <canvas id="budgetChart" width="300" height="300"></canvas>
    </div>
  `;

  // ì „ì—­ë³€ìˆ˜ë¡œ ì €ì¥
  window.usedAmount = usedAmount;
}

function drawChart() {
  const totalInput = document.getElementById("totalBudget");
  const usedInput = document.getElementById("usedBudget");

  if (!totalInput || !usedInput) {
    console.error("ì˜ˆì‚° ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const total = parseInt(totalInput.value) || 0;
  const used = parseInt(usedInput.value) || 0;
  const remain = total - used;

  const ctx = document.getElementById('budgetChart').getContext('2d');
  if (window.budgetChartInstance) {
    window.budgetChartInstance.destroy();
  }

  window.budgetChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['ì‚¬ìš©í•œ ê¸ˆì•¡', 'ë‚¨ì€ ê¸ˆì•¡'],
      datasets: [{
        data: [used, remain > 0 ? remain : 0],
        backgroundColor: ['#CE6969', '#83A2DB'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            font: {
              family: 'SUIT',
              size: 14
            }
          }
        }
      }
    }
  });
}

//       async function showBudget() {
//   const main = document.getElementById("main");

//   // ì´ë²ˆ ë‹¬ ì‚¬ìš© ê¸ˆì•¡ ì„œë²„ì—ì„œ ë°›ì•„ì˜¤ê¸°
//   let usedAmount = 0;
//   try {
//     const res = await fetch(`http://localhost:3000/api/receipts/usage/month/${user_id}`, {
//       headers: { Authorization: `Bearer ${user_token}` }
//     });
//     const data = await res.json();
//     usedAmount = data.total_used || 0;
//   } catch (err) {
//     console.error("ì´ë²ˆ ë‹¬ ì‚¬ìš© ê¸ˆì•¡ ì¡°íšŒ ì‹¤íŒ¨:", err);
//   }

//   main.innerHTML = `
//     <div class="glass-box">
//       <h2>ì´ë²ˆ ë‹¬ ì˜ˆì‚°</h2>
//       <p style="font-size: 16px; margin-bottom: 15px;">ì´ë²ˆ ë‹¬ ì§€ì¶œ ì´í•©: <strong>${usedAmount.toLocaleString()}ì›</strong></p>
//       <input type="number" id="totalBudget" placeholder="ì´ ì˜ˆì‚° ì…ë ¥ (â‚©)" style="padding: 5px 16px; margin-bottom: 20px; border-radius: 8px;" />
//       <button onclick="drawChart()" style="margin-top:10px; padding:8px 16px; border:none; background:#83A2DB; color:white; border-radius:8px;">í•œëˆˆì— í™•ì¸</button>
//       <canvas id="budgetChart" width="300" height="300"></canvas>
//     </div>
//   `;

//   // ì‚¬ìš©í•œ ê¸ˆì•¡ì€ ì „ì—­ë³€ìˆ˜ë¡œ ì €ì¥í•´ë‘ê³  ì°¨íŠ¸ ê·¸ë¦´ ë•Œ ì”ë‹ˆë‹¤.
//   window.usedAmount = usedAmount;
// }

// function drawChart() {
//   const totalInput = document.getElementById("totalBudget");
//   const usedInput = document.getElementById("usedBudget");

//   if (!totalInput || !usedInput) {
//     console.error("ì˜ˆì‚° ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
//     return;
//   }

//   const total = parseInt(totalInput.value);
//   const used = parseInt(usedInput.value);
//   const remain = total - used;

//   const ctx = document.getElementById('budgetChart').getContext('2d');
//   // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
//   if (window.budgetChartInstance) {
//     window.budgetChartInstance.destroy();
//   }

//   window.budgetChartInstance = new Chart(ctx, {
//     type: 'doughnut',
//     data: {
//       labels: ['ì‚¬ìš©í•œ ê¸ˆì•¡', 'ë‚¨ì€ ê¸ˆì•¡'],
//       datasets: [{
//         data: [used, remain > 0 ? remain : 0],
//         backgroundColor: ['#CE6969', '#83A2DB'],
//         borderWidth: 1
//       }]
//     },
//     options: {
//       responsive: true,
//       plugins: {
//         legend: {
//           position: 'bottom',
//           labels: {
//             font: {
//               family: 'SUIT',
//               size: 14
//             }
//           }
//         }
//       }
//     }
//   });
// }

  
      function drawChart() {
        const total = parseInt(document.getElementById("totalBudget").value);
        const used = parseInt(document.getElementById("usedBudget").value);
        const remain = total - used;
  
        const ctx = document.getElementById('budgetChart').getContext('2d');
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['ì‚¬ìš©í•œ ê¸ˆì•¡', 'ë‚¨ì€ ê¸ˆì•¡'],
            datasets: [{
              data: [used, remain],
              backgroundColor: ['#CE6969', '#83A2DB'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  font: {
                    family: 'SUIT',
                    size: 14
                  }
                }
              }
            }
          }
        });
      }
  
async function showEmotionDiary() {
  const main = document.getElementById("main");

  const today = new Date();
  const end = today.toISOString().split('T')[0];

  const past = new Date();
  past.setDate(today.getDate() - 6); // ì˜¤ëŠ˜ í¬í•¨ ìµœê·¼ 7ì¼
  const start = past.toISOString().split('T')[0];

  main.innerHTML = `
    <div id="calendar-view">
      <div class="emotion-diary-container">
        <div class="glass-col emotion-table">
          <h2 style="text-align:center; font-weight:bold;">ê°ì • ë‹¤ì´ì–´ë¦¬</h2>
          <table id="diaryTable">
            <thead>
              <tr>
                <th>ë‚ ì§œ</th>
                <th>ê°ì •</th>
                <th>ê·¸ë‚ ì˜ ë¬¸ì¥</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="3" style="text-align:center;">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="glass-col" style="flex: 1;">
          <h3 style="font-size:25px;">ì´ë²ˆ ì£¼ì˜ ê°ì •</h3>
          <canvas id="threeCanvas" style="width: 100%; height: 300px;"></canvas>
        </div>
      </div>
    </div>
  `;

  const url = `http://localhost:3000/api/emotion-diary/range?userId=${user_id}&start=${start}&end=${end}`;

  try {
    const res = await fetch(url, {
      headers: { Authorization: `Bearer ${user_token}` }
    });
    const data = await res.json();

    if (data.err) {
      if (data.err.name === "TokenExpiredError") {
        alert("ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        window.location.href = "login.html";
        return;
      }
      throw new Error(data.err.message || "ì„œë²„ ì—ëŸ¬");
    }

    const tbody = document.querySelector("#diaryTable tbody");
    const emotionMap = {
      'ê¸°ì¨': 'ğŸ˜„',
      'ì¤‘ë¦½': 'ğŸ˜',
      'ë¶ˆì•ˆ': 'ğŸ¥¶',
      'ìŠ¬í””': 'ğŸ˜­',
      'ë¶„ë…¸': 'ğŸ˜¡'
    };
    const emotionCount = {};

    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;">ê°ì • ì¼ê¸° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
    } else {
      tbody.innerHTML = "";

      data.forEach(entry => {
        const dateOnly = entry.date.includes('T') ? entry.date.split('T')[0] : entry.date;
        const dateFormatted = dateOnly.slice(5).replace('-', '/');
        const emoji = emotionMap[entry.emotion] || 'â“';

        // ê°ì • ì¹´ìš´íŠ¸ ëˆ„ì 
        if (entry.emotion) {
          emotionCount[entry.emotion] = (emotionCount[entry.emotion] || 0) + 1;
        }

        tbody.innerHTML += `
          <tr>
            <td>${dateFormatted}</td>
            <td style="font-size:24px;">${emoji}</td>
            <td>${entry.sentence || ''}</td>
          </tr>
        `;
      });

      // ê°€ì¥ ë§ì´ ë‚˜ì˜¨ ê°ì • ì°¾ê¸°
      const topEmotion = Object.entries(emotionCount)
        .sort((a, b) => b[1] - a[1])[0]?.[0];

     // ê°ì •ë³„ ì„¤ì • ë§µ
const modelConfigMap = {
  'ê¸°ì¨':  { file: 'happy.glb',  scale: [20, 20, 20], position: [-45, 0, 0], rotationY: -Math.PI / 2 },
  'ì¤‘ë¦½':  { file: 'normal.glb',scale: [20,20,20], position: [114, 0, -4.0],rotationY: -Math.PI / 2 },
  'ë¶ˆì•ˆ':  { file: 'anxious.glb',  scale: [20, 20, 20], position: [-6, 0, 0], rotationY: -Math.PI / 2 },
  'ìŠ¬í””':  { file: 'sad.glb',  scale: [20, 20, 20], position: [-127, 0, -6.0], rotationY: -Math.PI / 2 }, 
  'ë¶„ë…¸':  { file: 'angry.glb',scale: [20,20,20], position: [72, 0, -4.0],rotationY: -Math.PI / 2 },
};

const config = modelConfigMap[topEmotion];

if (config) {
  init3D();
  const loader = new THREE.GLTFLoader();
  loader.load(`../models/${config.file}`, (gltf) => {
    if (model) scene.remove(model);
    model = gltf.scene;

    model.scale.set(...config.scale);
    model.position.set(...config.position);
    model.rotation.y = config.rotationY;

    scene.add(model);
    });
  }

  // ê¸ì • ë¬¸êµ¬ ì¶œë ¥ ì¡°ê±´ í™•ì¸ ë° ì‚½ì…
  const negativeEmotions = ['ë¶„ë…¸', 'ë¶ˆì•ˆ', 'ìŠ¬í””'];
  if (negativeEmotions.includes(topEmotion)) {
    const affirmationBox = document.createElement("div");
    affirmationBox.className = "glass-box";
    affirmationBox.id = "affirmationBox";
    affirmationBox.style.maxWidth = "100%";
    affirmationBox.style.margin = "10px auto";   
    affirmationBox.style.display = "block";  
    affirmationBox.innerHTML = `<p style="font-size: 16px;">ê¸ì • ë¬¸êµ¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
    document.getElementById("calendar-view").appendChild(affirmationBox);

    loadAffirmation(); // ê¸°ì¡´ ì •ì˜ëœ ê¸ì • ë¬¸êµ¬ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ í˜¸ì¶œ
  }



    }
  } catch (err) {
    console.error("ê°ì • ì¼ê¸° ì¡°íšŒ ì‹¤íŒ¨:", err);
    const tbody = document.querySelector("#diaryTable tbody");
    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:red;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>`;
  }
}


function showSpending() {
  document.getElementById("main").innerHTML = `
    <div class="glass-box">
      <h2></h2>
      <select id="chartSelector" style="padding: 8px 16px; margin-bottom: 20px; border-radius: 8px;">
        <option value="emotionTotal">ê°ì •ë³„ ì§€ì¶œ ì´ì•¡</option>
        <option value="dailyEmotion">ì¼ë³„ ê°ì •ê³¼ ì§€ì¶œ</option>
        <option value="categoryTotal">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</option>
      </select>
      <canvas id="spendingChart" height="300"></canvas>
    </div>
  `;

  // chart ë³€ìˆ˜ë¥¼ ì „ì—­ì²˜ëŸ¼ ì²˜ë¦¬ (ì¬ì‚¬ìš© ìœ„í•´)
  let currentChart = null;

  const selector = document.getElementById("chartSelector");
  selector.addEventListener("change", drawSelectedChart);
  drawSelectedChart();  // ì²« ì‹¤í–‰

  async function drawSelectedChart() {
    const selected = selector.value;
    const canvas = document.getElementById("spendingChart");
    const ctx = canvas.getContext("2d");

    if (currentChart) {
      currentChart.destroy();
    }

    if (document.getElementById('emotionSummary')) {
      document.getElementById('emotionSummary').remove();
    }

    if (selected === "emotionTotal") {
      currentChart = await drawEmotionTotalChart(ctx);
    } else if (selected === "dailyEmotion") {
      currentChart = await drawDailyEmotionChart(ctx);
    } else if (selected === "categoryTotal") {
      currentChart = await drawCategoryChart(ctx);
    }
  }

  async function drawEmotionTotalChart(ctx) {
    try {
      const res = await fetch("http://localhost:3000/api/graph/emotion", {
        headers: { Authorization: `Bearer ${user_token}` }
      });
      const data = await res.json();

      const labels = data.map(d => d.emotion);
      const values = data.map(d => d.total);
            
      // ì¤‘ë¦½ ê¸°ì¨ ë¶ˆì•ˆ ë¶„ë…¸ ìŠ¬í””
      const colors = ['#97C1A9', '#FFE880', '#CBAACB', '#ce6969', '#83A2DB'];
      const total = values.reduce((a, b) => a + b, 0);
      const percents = values.map(v => Math.round((v / total) * 100));
      const maxIndex = values.indexOf(Math.max(...values));

      const summary = document.createElement("h3");
      summary.id = "emotionSummary";
      summary.style.textAlign = "center";
      summary.style.marginBottom = "15px";
      summary.innerHTML = `ìµœê·¼ í•œ ë‹¬ ê°„ <span style="color:${colors[maxIndex]};  text-shadow:
        -0.5px -0.5px 0 gray,
         0.5px -0.5px 0 gray,
        -0.5px  0.5px 0 gray,
         0.5px  0.5px 0 gray; font-weight:bold; font-size:30px">${labels[maxIndex]}</span> ê°ì •ì—ì„œ ì§€ì¶œì´ ê°€ì¥ ë§ì•„ìš”`;
      document.querySelector(".glass-box").insertBefore(summary, document.getElementById("spendingChart"));

      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'ì§€ì¶œ ì´ì•¡',
            data: values,
            backgroundColor: colors,
            borderRadius: 10
          }]
        },
        options: {
          indexAxis: 'y',
          plugins: {
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  return `â‚©${ctx.raw.toLocaleString()} (${percents[ctx.dataIndex]}%)`;
                }
              }
            },
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true }
          }
        }
      });
    } catch (err) {
      console.error("emotion chart error:", err);
    }
  }
async function drawDailyEmotionChart(ctx) {
  try {
    const res = await fetch("http://localhost:3000/api/graph/daily", {
      headers: { Authorization: `Bearer ${user_token}` }
    });
    const data = await res.json();

    // ë‚ ì§œì—ì„œ ì‹œê°„ ì œê±°
    data.forEach(d => {
      if (typeof d.date === 'string' && d.date.includes('T')) {
        d.date = d.date.split('T')[0];
      }
    });

    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(d => d.date),
        datasets: [{
          label: 'ì¼ë³„ ê°ì • ì§€ì¶œ',
          data: data.map(d => d.total),
          fill: false,
          borderColor: '#83A2DB',
          tension: 0.3
        }]
      },
      options: {
        plugins: {
          tooltip: {
            multiLine: true,
            callbacks: {
              label: function (ctx) {
                const item = data[ctx.dataIndex];
                return [`ë‚ ì§œ: ${item.date}`, `ê°ì •: ${item.emotion}`, `ì§€ì¶œ: â‚©${item.total.toLocaleString()}`];
              }
            }
          },
          legend: { display: false }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  } catch (err) {
    console.error("daily chart error:", err);
  }
}


  async function drawCategoryChart(ctx) {
    try {
      const res = await fetch("http://localhost:3000/api/graph/category", {
        headers: { Authorization: `Bearer ${user_token}` }
      });
      const data = await res.json();

      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.category),
          datasets: [{
            label: 'ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ',
            data: data.map(d => d.total),
            backgroundColor: '#83A2DB',
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    } catch (err) {
      console.error("category chart error:", err);
    }
  }
}


      function showCalendar() {
  document.getElementById("main").innerHTML = `
    <div id='calendar-container'>
      <div id='calendar'></div>
    </div>
  `;

  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'ko',
    height: 'auto',
    headerToolbar: {
      left: 'prev',
      center: 'title',
      right: 'next'
    },
    events: function(fetchInfo, successCallback, failureCallback) {
      // fetchInfo.startStr, fetchInfo.endStr ì— í˜„ì¬ ë‹¬ë ¥ì— ë³´ì´ëŠ” ì‹œì‘, ë ë‚ ì§œ(YYYY-MM-DD)
      fetch(`http://localhost:3000/api/receipts/usage/range?userId=${user_id}&start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`, {
        headers: {
          Authorization: `Bearer ${user_token}`
        }
      })
      .then(response => response.json())
      .then(data => {
        // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° [{date, emotion, amount}, ...]ì„
        // FullCalendar ì´ë²¤íŠ¸ í¬ë§·ìœ¼ë¡œ ë³€í™˜
        const events = data.map(item => ({
          start: item.date,
          extendedProps: {
            emotion: item.emotion,
            amount: item.amount
          }
        }));
        successCallback(events);
      })
      .catch(err => {
        console.error('ì´ë²¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', err);
        failureCallback(err);
      });
    },
    eventContent: function (arg) {
      const emotionMap = {
        'ê¸°ì¨': 'ğŸ˜„',
        'ì¤‘ë¦½': 'ğŸ˜',
        'ë¶ˆì•ˆ': 'ğŸ¥¶',
        'ìŠ¬í””': 'ğŸ˜­',
        'ë¶„ë…¸': 'ğŸ˜¡'
      };
      const emotion = arg.event.extendedProps.emotion || '';
      const emoji = emotionMap[emotion] || 'â“';
      const amount = arg.event.extendedProps.amount || 0;
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div style="font-size:35px;">${emoji}</div>
        <div style="font-size:12px; color:#444;">â‚©${amount.toLocaleString()}</div>
      `;
      return { domNodes: [wrapper] };
    },
    eventDidMount: function (info) {
      info.el.style.backgroundColor = 'transparent';
      info.el.style.border = 'none';
      info.el.style.textAlign = 'center';
    }
  });

  calendar.render();
  
}


      let scene, camera, renderer, model,controls;
    
      function showEmotion() {
        document.getElementById("main").innerHTML = `
          <div class="glass-row-2" style="max-width: 800px; width: 100%;">
            <div class="glass-col" style="flex: 1;">
              <h3>ê°ì •ì„ ì…ë ¥í•˜ì„¸ìš”</h3>
              <input type="text" id="emotionInput" placeholder="í–‰ë³µ, ìŠ¬í””, ë¶ˆì•ˆ, ë¶„ë…¸"
                style="width: 100%; padding: 10px; border-radius: 8px;" />
              <button onclick="loadEmotionModel()" 
                style="margin-top:10px; padding:8px 16px; border:none; background:#83A2DB; color:white; border-radius:8px;">
                ì ìš©
              </button>
            </div>
            <div class="glass-col" style="flex: 1;">
              <h3>ê°ì • ìºë¦­í„°</h3>
              <canvas id="threeCanvas" style="width: 100%; height: 300px;"></canvas>
            </div>
          </div>

          <!-- ê¸ì • ë¬¸êµ¬ ë°•ìŠ¤ëŠ” ì²˜ìŒì—” ë¹„ì›Œë‘ê³  ë‚˜ì¤‘ì— ì¡°ê±´ì— ë”°ë¼ ì‚½ì… -->
          <div class="glass-box" id="affirmationBox" style="max-width: 800px; display: none;">
          </div>
        `;

        init3D(); // 3D ì„¤ì •
      }





    function init3D() {
      const canvas = document.getElementById('threeCanvas');
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
      camera.position.set(0, 1.5,80);  // ë©€ë¦¬ì„œ ë³´ê¸°

      renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setClearColor(0x000000, 0);  // íˆ¬ëª… ë°°ê²½

      // ì¡°ëª…
      const ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
      directionalLight.position.set(5, 10, 7.5);
      scene.add(ambientLight, directionalLight);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enablePan = false;
      controls.enableZoom = false;
      controls.target.set(0, 0, 0);  // ëª¨ë¸ ì¤‘ì‹¬
      controls.update();


      // ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘
      window.addEventListener('resize', () => {
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height);
      });

      animate(); // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    }

    function loadEmotionModel() {
      const input = document.getElementById("emotionInput").value.trim();
      const map = {
        'í–‰ë³µ': 'happy.glb',
        'ìŠ¬í””': 'sad.glb',
        'ë¶ˆì•ˆ': 'anxious.glb',
        'ë¶„ë…¸': 'angry.glb'
      };
      const fileName = map[input];
      if (!fileName) {
        alert("ê°ì •ì€ 'í–‰ë³µ', 'ìŠ¬í””', 'ë¶ˆì•ˆ', 'ë¶„ë…¸' ì¤‘ì—ì„œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      const loader = new THREE.GLTFLoader();
      loader.load(`models/${fileName}`, (gltf) => {
      if (model) scene.remove(model);

      model = gltf.scene;

      // í¬ê¸°ì™€ ìœ„ì¹˜ ì¡°ì •
      model.scale.set(0.06,0.06,0.06);   // ìºë¦­í„° ì‚¬ì´ì¦ˆ ì¡°ì ˆ
      model.position.set(0, 0, 0);   // ì•„ë˜ë¡œ

      model.rotation.y = Math.PI / 2; // ìºë¦­í„°ê°€ ì•ì„ ë³´ë„ë¡

      // ëª¨ë¸ ë‚´ë¶€ êµ¬ì¡° í™•ì¸
      model.traverse((child) => {
        if (child.isMesh) {
          child.castShadow = true;
          child.receiveShadow = true;
          console.log("Mesh:", child.name);
        }
      });

      scene.add(model);
      console.log("ëª¨ë¸ ì”¬ì— ì¶”ê°€");
      });




    }

    function animate() {
      requestAnimationFrame(animate);
      // if (model) model.rotation.y += 0.005;  // ì²œì²œíˆ íšŒì „
      if (controls) controls.update();  // ë§ˆìš°ìŠ¤ íšŒì „ ì ìš©

      renderer.render(scene, camera);
    }






    </script>
  </body>
  </html>
  
